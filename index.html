<script>
const catalog=document.getElementById('catalog');
const sheets=document.getElementById('sheets');
let currentSheet;

/* CARREGAR FLASHES */
for(let i=1;i<=40;i++){
const img=document.createElement('img');
img.src='flashes/'+i+'.png';
img.onclick=()=>addFlash(img.src);
catalog.appendChild(img);
}

/* NOVA FOLHA */
function newSheet(){
const wrap=document.createElement('div');
wrap.className='sheetWrapper';

currentSheet=document.createElement('div');
currentSheet.className='sheet';
wrap.appendChild(currentSheet);

/* BOT√ÉO ESPELHAR */
const flipBtn=document.createElement('button');
flipBtn.textContent='‚áã';
flipBtn.style.position='absolute';
flipBtn.style.top='10px';
flipBtn.style.right='10px';
flipBtn.style.zIndex='10';
flipBtn.onclick=()=>{ currentSheet.classList.toggle('flipped'); };
wrap.appendChild(flipBtn);

sheets.appendChild(wrap);
}
newSheet();

/* CSS ESPELHO */
const style=document.createElement('style');
style.innerHTML=`.flipped{transform:scaleX(-1);} `;
document.head.appendChild(style);

/* POSI√á√ÉO AUTOM√ÅTICA */
function getNextPosition(){
const items=currentSheet.querySelectorAll('.item');
const cols=5;          // MAIS COLUNAS
const margin=8;
const w=(currentSheet.clientWidth-margin*(cols+1))/cols;

let i=items.length;
return{
x:margin+(i%cols)*(w+margin),
y:margin+Math.floor(i/cols)*(w+margin)
};
}

/* ADICIONAR FLASH */
function addFlash(src){
const pos=getNextPosition();
const div=document.createElement('div');
div.className='item';
div.style.left=pos.x+'px';
div.style.top=pos.y+'px';
div.style.width='90px'; // üî• menor

div.innerHTML=`<img src="${src}"><br>
<button onclick="resize(this,8)">+</button>
<button onclick="resize(this,-8)">-</button>
<button onclick="this.parentElement.remove()">X</button>`;

makeDraggable(div);
currentSheet.appendChild(div);
}

function resize(btn,val){
const p=btn.parentElement;
p.style.width=(p.offsetWidth+val)+'px';
}

/* ORGANIZAR */
function organize(){
const items=currentSheet.querySelectorAll('.item');
items.forEach((it,i)=>{
const cols=5,margin=8;
const w=(currentSheet.clientWidth-margin*(cols+1))/cols;
it.style.left=(margin+(i%cols)*(w+margin))+'px';
it.style.top=(margin+Math.floor(i/cols)*(w+margin))+'px';
});
}

/* TEXTO */
function addTextToSheet(){
const text=document.getElementById('textInput').value;
if(!text)return;
const div=document.createElement('div');
div.className='textItem';
div.dataset.text=text;
div.style.left='120px';
div.style.top='200px';
updateText(div);

const btns=document.createElement('div');
btns.className='textBtns';
btns.innerHTML=`<button onclick="this.parentElement.parentElement.remove()">üóë</button>`;
div.appendChild(btns);

makeDraggable(div);
currentSheet.appendChild(div);
}

function updateText(div){
div.style.fontSize=sizeRange.value+'px';
div.style.fontFamily=fontSelect.value;
div.style.letterSpacing=spacingRange.value+'px';
div.style.webkitTextStroke=outlineRange.value+'px black';
div.style.textShadow=shadowRange.value>0?`2px 2px ${shadowRange.value}px rgba(0,0,0,0.5)`:'none';
div.textContent=div.dataset.text;
}

document.querySelectorAll('input,select').forEach(el=>{
el.oninput=()=>{
const t=currentSheet.querySelector('.textItem');
if(t)updateText(t);
}
});

/* ARRASTAR */
function makeDraggable(el){
let isDown=false, offsetX=0, offsetY=0;

el.addEventListener('mousedown',start);
el.addEventListener('touchstart',start);

function start(e){
isDown=true;
const rect=el.getBoundingClientRect();
offsetX=(e.touches?e.touches[0].clientX:e.clientX)-rect.left;
offsetY=(e.touches?e.touches[0].clientY:e.clientY)-rect.top;
document.addEventListener('mousemove',move);
document.addEventListener('touchmove',move);
document.addEventListener('mouseup',stop);
document.addEventListener('touchend',stop);
}

function move(e){
if(!isDown)return;
let x=(e.touches?e.touches[0].clientX:e.clientX)-offsetX;
let y=(e.touches?e.touches[0].clientY:e.clientY)-offsetY;
el.style.left=(x-currentSheet.getBoundingClientRect().left)+'px';
el.style.top=(y-currentSheet.getBoundingClientRect().top)+'px';
}

function stop(){
isDown=false;
document.removeEventListener('mousemove',move);
document.removeEventListener('touchmove',move);
}
}
</script>

