<script>
const catalog=document.getElementById('catalog');
const sheets=document.getElementById('sheets');
let currentSheet=null;

/* PROTEÃ‡ÃƒO â€” sÃ³ roda se os elementos existirem */
if(catalog){
for(let i=1;i<=40;i++){
const img=document.createElement('img');
img.src='flashes/'+i+'.png';
img.onclick=()=>addFlash(img.src);
catalog.appendChild(img);
}
}

function newSheet(){
const wrap=document.createElement('div');
wrap.className='sheetWrapper';

currentSheet=document.createElement('div');
currentSheet.className='sheet';
wrap.appendChild(currentSheet);

/* BOTÃƒO ESPELHAR */
const flipBtn=document.createElement('button');
flipBtn.textContent='â‡‹';
flipBtn.style.position='absolute';
flipBtn.style.top='10px';
flipBtn.style.right='10px';
flipBtn.style.zIndex='10';
flipBtn.onclick=()=>{ currentSheet.classList.toggle('flipped'); };
wrap.appendChild(flipBtn);

sheets.appendChild(wrap);
}
newSheet();

/* ESPELHO */
const style=document.createElement('style');
style.innerHTML=`.flipped{transform:scaleX(-1);} `;
document.head.appendChild(style);

/* POSIÃ‡ÃƒO */
function getNextPosition(){
const items=currentSheet.querySelectorAll('.item');
const cols=5, margin=8;
const w=(currentSheet.clientWidth-margin*(cols+1))/cols;
let i=items.length;
return{ x:margin+(i%cols)*(w+margin), y:margin+Math.floor(i/cols)*(w+margin)};
}

/* FLASH */
function addFlash(src){
const pos=getNextPosition();
const div=document.createElement('div');
div.className='item';
div.style.left=pos.x+'px';
div.style.top=pos.y+'px';
div.style.width='90px';

div.innerHTML=`<img src="${src}"><br>
<button onclick="resize(this,8)">+</button>
<button onclick="resize(this,-8)">-</button>
<button onclick="this.parentElement.remove()">X</button>`;

makeDraggable(div);
currentSheet.appendChild(div);
}

function resize(btn,val){
const p=btn.parentElement;
p.style.width=(p.offsetWidth+val)+'px';
}

/* TEXTO */
function addTextToSheet(){
const input=document.getElementById('textInput');
if(!input)return;

const text=input.value;
if(!text)return;

const div=document.createElement('div');
div.className='textItem';
div.dataset.text=text;
div.style.left='120px';
div.style.top='200px';
updateText(div);

const btns=document.createElement('div');
btns.className='textBtns';
btns.innerHTML=`<button onclick="this.parentElement.parentElement.remove()">ðŸ—‘</button>`;
div.appendChild(btns);

makeDraggable(div);
currentSheet.appendChild(div);
}

function updateText(div){
const size=document.getElementById('sizeRange');
const font=document.getElementById('fontSelect');
const spacing=document.getElementById('spacingRange');
const outline=document.getElementById('outlineRange');
const shadow=document.getElementById('shadowRange');

if(!size||!font||!spacing||!outline||!shadow)return;

div.style.fontSize=size.value+'px';
div.style.fontFamily=font.value;
div.style.letterSpacing=spacing.value+'px';
div.style.webkitTextStroke=outline.value+'px black';
div.style.textShadow=shadow.value>0?`2px 2px ${shadow.value}px rgba(0,0,0,0.5)`:'none';
div.textContent=div.dataset.text;
}

/* ARRASTAR */
function makeDraggable(el){
let isDown=false, offsetX=0, offsetY=0;

el.addEventListener('mousedown',start);
el.addEventListener('touchstart',start);

function start(e){
isDown=true;
const rect=el.getBoundingClientRect();
offsetX=(e.touches?e.touches[0].clientX:e.clientX)-rect.left;
offsetY=(e.touches?e.touches[0].clientY:e.clientY)-rect.top;
document.addEventListener('mousemove',move);
document.addEventListener('touchmove',move);
document.addEventListener('mouseup',stop);
document.addEventListener('touchend',stop);
}

function move(e){
if(!isDown)return;
let x=(e.touches?e.touches[0].clientX:e.clientX)-offsetX;
let y=(e.touches?e.touches[0].clientY:e.clientY)-offsetY;
el.style.left=(x-currentSheet.getBoundingClientRect().left)+'px';
el.style.top=(y-currentSheet.getBoundingClientRect().top)+'px';
}

function stop(){
isDown=false;
document.removeEventListener('mousemove',move);
document.removeEventListener('touchmove',move);
}
}
</script>
